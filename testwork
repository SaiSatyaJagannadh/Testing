import json
import zipfile
import pandas as pd
from pathlib import Path
import logging
from config import INPUT_DIR, UPLOADS_DIR

# Set logging to WARNING to reduce output
logging.basicConfig(level=logging.WARNING)
logger = logging.getLogger(__name__)

class FileReader:
    def __init__(self):
        self.knowledge_data = []
        self.load_knowledge_base()
    
    def load_knowledge_base(self):
        """Load existing knowledge from input folder"""
        try:
            print(f"Loading knowledge base from: {INPUT_DIR}")
            
            for file_path in INPUT_DIR.glob('*'):
                if file_path.suffix.lower() in ['.xlsx', '.csv']:
                    print(f"Reading Excel: {file_path.name}")
                    excel_data = self._read_excel(file_path)
                    self.knowledge_data.extend(excel_data)
                    print(f"✓ Added {len(excel_data)} entries from Excel")
                    
                elif file_path.suffix.lower() == '.zip':
                    print(f"Reading ZIP: {file_path.name}")
                    zip_data = self._read_zip(file_path)
                    self.knowledge_data.extend(zip_data)
                    print(f"✓ Added {len(zip_data)} entries from ZIP")
            
            print(f"✓ TOTAL LOADED: {len(self.knowledge_data)} knowledge entries")
            
        except Exception as e:
            print(f"Error loading knowledge base: {str(e)}")
    
    def read_uploaded_file(self, file_path):
        """Read newly uploaded file"""
        file_path = Path(file_path)
        
        if file_path.suffix.lower() in ['.txt', '.log']:
            return self._read_log_file(file_path)
        elif file_path.suffix.lower() == '.json':
            return self._read_json(file_path)
        elif file_path.suffix.lower() in ['.xlsx', '.csv']:
            return self._read_excel(file_path)
        elif file_path.suffix.lower() == '.zip':
            return self._read_zip(file_path)
        else:
            raise ValueError(f"Unsupported file format: {file_path.suffix}")
    
    def _read_log_file(self, file_path):
        """Read text/log files"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            lines = content.split('\n')
            log_data = {
                'filename': file_path.name,
                'content': content,
                'lines': lines,
                'total_lines': len(lines)
            }
            return [log_data]
        except Exception as e:
            print(f"Error reading log file: {str(e)}")
            return []
    
    def _read_excel(self, file_path):
        """Read Excel/CSV files"""
        try:
            if file_path.suffix.lower() == '.csv':
                df = pd.read_csv(file_path)
            else:
                df = pd.read_excel(file_path)
            
            # Convert to standard format
            data = []
            for _, row in df.iterrows():
                # Try different column names
                jobname = str(row.get('jobname', '') or row.get('job_name', '') or row.get('JobName', ''))
                error = str(row.get('error', '') or row.get('errors', '') or row.get('Error', ''))
                solution = str(row.get('solution', '') or row.get('solutions', '') or row.get('Solution', ''))
                
                entry = {
                    'jobname': jobname,
                    'error': error,
                    'solution': solution,
                    'source': file_path.name
                }
                
                # Only add if both error and solution exist and are not 'nan'
                if (entry['error'] and entry['solution'] and 
                    entry['error'] != 'nan' and entry['solution'] != 'nan'):
                    data.append(entry)
            
            return data
            
        except Exception as e:
            print(f"Error reading Excel file: {str(e)}")
            return []
    
    def _read_json(self, file_path):
        """Read JSON files"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            if isinstance(data, list):
                return data
            elif isinstance(data, dict):
                return [data]
            return []
        except Exception as e:
            print(f"Error reading JSON file: {str(e)}")
            return []
    
    def _read_zip(self, file_path):
        """Read ZIP files and extract text files"""
        try:
            extracted_data = []
            with zipfile.ZipFile(file_path, 'r') as zip_ref:
                for file_info in zip_ref.filelist:
                    if file_info.filename.endswith(('.txt', '.log')):
                        content = zip_ref.read(file_info.filename).decode('utf-8')
                        log_data = {
                            'filename': file_info.filename,
                            'content': content,
                            'lines': content.split('\n'),
                            'source_zip': file_path.name
                        }
                        extracted_data.append(log_data)
            return extracted_data
        except Exception as e:
            print(f"Error reading ZIP file: {str(e)}")
            return []
    
    def get_knowledge_base(self):
        """Return loaded knowledge base"""
        return self.knowledge_data
